<!DOCTYPE html>
<html lang="en" ng-app="treasure-hunt">
<head>
    <meta charset="utf-8">

    <!-- Mobile-first -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"
          integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
            integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
            crossorigin="anonymous"></script>

    <!-- Angular JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>

    <title>Aarde mäng: ülesanne</title>

</head>

<body style="margin: 20px">

<script type="text/javascript" charset="UTF-8">
    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) {
                return pair[1];
            }
        }
        return (false);
    }</script>

<div ng-controller="get-assignment">
    <div class="progress">
        <div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="{{completed}}"
             aria-valuemin="0"
             aria-valuemax="{{total}}" style="width:{{100 / (total/completed) | number:0}}%">
            on läbitud {{completed}}/{{total}}
        </div>
    </div>

    <div id="team">
        <h3 class="text-right text-info">
            <script type="text/javascript">document.write(getQueryVariable("teamTitle"));</script>
        </h3>
    </div>

    <div class="panel panel-default" ng-show="text">
        <div class="panel-body">{{text}}</div>
    </div>

    <div ng-controller="submit-solution" ng-submit="submitSolution()">
        <form name="solution-submit-form" method="">
            <input type="text" class="form-control" ng-model="solution" ng-required="true" placeholder="lahendus..."
                   name="solution"><br>
            <input type="submit" class="btn btn-success btn-lg center-block" name="submit-solution"
                   value="Esita">
        </form>

        <div class="alert alert-danger" style="margin-top: 10px" ng-show="messages.error"
             ng-repeat="e in messages.error">
            {{e}}
        </div>

        <div class="alert alert-danger" style="margin-top: 10px" ng-show="fail">
            {{fail}}
        </div>

        <div class="alert alert-warning" style="margin-top: 10px" ng-show="messages.warning"
             ng-repeat="w in messages.warning">
            {{w}}
        </div>

        <div class="alert alert-success" style="margin-top: 10px" ng-show="messages.success"
             ng-repeat="s in messages.success">
            {{s}}
        </div>

        <div  ng-controller="get-new-assignment" ng-submit="getNewAssignment()" ng-show="!text"
             style="margin-top:10px">
            <form name="next-assignment-form" method="">
                <input type="submit" class="btn btn-primary btn-lg center-block"
                       name="get-next-assigment" value="Järgmine ülesanne">
            </form>

            <div class="alert alert-danger" style="margin-top: 10px" ng-show="aError">
                {{aError}}
            </div>
        </div>

    </div>
</div>

<script type="text/javascript" charset="UTF-8">

    function getParameter(theParameter) {
        var params = window.location.search.substr(1).split('&');

        for (var i = 0; i < params.length; i++) {
            var p = params[i].split('=');
            if (p[0] == theParameter) {
                return decodeURIComponent(p[1]);
            }
        }
        return false;
    }

    var app = angular.module("treasure-hunt", []);
    var gameId = getParameter("gameId");
    var teamId = getParameter(("teamId"));
    var url = "/api/games/" + gameId + "/teams/" + teamId;

    app.controller("get-assignment", function ($scope, $http) {
        $http({
            url: url,
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        }).success(function (data) {
            $scope.text = data.currentassignment.text;
            $scope.total = data.challengesTotal;
            $scope.completed = data.challengesCompleted;
        }).error(function (data, status) {
            //TODO
        });
    });

    app.controller("submit-solution", function ($scope, $http) {
        var solution = $scope.solution;

        $scope.submitSolution = function () {
            var json = JSON.stringify({solution: solution});

            $http({
                url: url,
                dataType: 'json',
                method: 'POST',
                data: json,
                headers: {'Content-Type': 'application/json'}
            }).success(function (data) {
                $scope.messages = data.messages;
            }).error(function (data, status) {
                $scope.fail = status + ": Andmete pärimine ebaõnnestus";
            });
        };
    });

    app.controller("get-new-assignment", function ($scope, $http, $window) {
        $scope.getNewAssignment = function () {
            $http({
                url: url + "?new-assignment",
                method: 'GET',
                headers: {'Content-Type': 'application/json'}
            }).success(function (data) {
                $window.location.reload();
            }).error(function (data, status) {
                $scope.aError = status + ": Andmete saatmine ebaõnnestus";
            });
        };
    });

</script>

</body>
</html>
